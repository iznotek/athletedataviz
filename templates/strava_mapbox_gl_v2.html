<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>AthleteDataViz</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <!-- Leaflet -->
    <!-- 
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script> -->
    <link rel="stylesheet" type="text/css" href="static/css/style.css">
    <!-- Mapbox GL -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.11.2/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.11.2/mapbox-gl.css' rel='stylesheet' />
    <!-- Mapbox JS -->
    <script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
    <!-- Leaflet Heat !-->
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script>
    <!-- Mapbox JS extended to Mapbox GL JS !-->
    <script src="/static/js/leaflet-mapbox-gl.js"></script>

    <style>

    </style>
</head>
<br>
<style>
body {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #618DFC;
  font-size: 13px;
  background-color: #A9A9A9;
  line-height: 1.5em;
  margin: 30px auto;
  padding: 0 50px;
}
#map { position:absolute; 
       top:0; 
       bottom:0; 
       right: 150px;
       width:100%; }
.ui-button1 {
  position:absolute;
  top: 50px;
  right:10px;
  z-index:1000;
  }
.ui-button2 {
  position:absolute;
  top: 100px;
  right:10px;
  z-index:1000;
  }
.ui-button3 {
  position:absolute;
  top: 150px;
  right:10px;
  z-index:1000;
  }
  .ui-button4 {
  position:absolute;
  top: 200px;
  right:10px;
  z-index:1000;
  }
  .ui-button5 {
  position:absolute;
  top: 250px;
  right:10px;
  z-index:1000;
  }
#loader {
position:absolute; top:0; bottom:0; width:100%;
background:rgba(255, 255, 255, 1);
transition:background 1s ease-out;
-webkit-transition:background 1s ease-out;
}
#loader.done {
    background:rgba(255, 255, 255, 0);
}
#loader.hide {
    display:none;
}
#loader .message {
    position:absolute;
    left:50%;
    top:50%;
}
#heattype {
    position: absolute;
    top: 300px;
    right: 10px;
    z-index:1000;;
    }
#blur {
    position: absolute;
    top: 350px;
    right: 10px;
    z-index:1000;;
    }
#radius {
    position: absolute;
    top: 400px;
    right: 10px;
    z-index:1000;;
    }
#minOpacity {
    position: absolute;
    top: 450px;
    right: 10px;
    z-index:1000;;
    }
#refresh {
    position: absolute;
    top: 500px;
    right: 10px;
    z-index:1000;;
    }
</style>
<body>
<form action="{{ url_for('homepage') }}" class='ui-button1'>
    <input type="submit" value="Homepage" style="font-size: 20px;">
</form>

<div title="Choose line Color">
<select id='line_color' name="line_color" onclick="render()" class="ui-button3" style="font-size: 20px;">
  <option value="#FFFF00">Yellow</option>
  <option value="#FF0000">Red</option>
  <option value="#0000FF">Blue</option>
</select>
</div>

<div title="Choose line width">
<select id='line_width' name="line_width" onclick="render()" class="ui-button4" style="font-size: 20px;">
  <option value=2>Normal</option>
  <option value=1>Thin</option>
  <option value=3>Bold</option>
</select>
</div>

<div title="Choose opacity">
<select id='line_opacity' onclick="render()" name="line_opacity" class="ui-button5" style="font-size: 20px;">
  <option value=0.2>Medium</option>
  <option value=0.1>Low</option>
  <option value=0.3>High</option>
</select>
</div>

<div title="Choose VizType">
<select id='VizType' name="VizType" onclick="render()" class="ui-button2" style="font-size: 20px;">
  <option value="heat-point">heat-point</option>
  <option value="heat-line">heat-line(N)</option>
</select>

<div title="Choose HeatType">
<select id='heattype' name="line_color" onclick="render()" class="ui-button3" style="font-size: 20px;">
  <option value="d">density</option>
  <option value="s">speed</option>
  <option value="g">grade</option>
</select>

<div title="Choose Blur">
<label for="blur">blur</label>
<input type="range" id="blur" min="2" value="5" max="30" step="1" onclick="render()" class="blur" style="font-size: 20px;">
</div>

<div title="Choose Radius">
<label for="radius">radius</label>
<input type="range" id="radius" min="2" value="5" max="30" step="1" onclick="render()" class="radius" style="font-size: 20px;">
</div>

<div title="Choose MinOpacity">
<label for="minOpacity">minOpacity</label>
<input type="range" id="minOpacity" min="0.1" value="0.5" max="1" step="0.1" onclick="render()" class="minOpacity" style="font-size: 20px;">
</div>

<style>
    #render_map {
        display: block;
        position: absolute;
        top: 0px;
        right: 10px;
        margin: 10px auto;
        width: 125px;
        height: 30px;
        padding: 15px auto;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        text-align: center;
        color: #fff;
        background: #ee8a65;
      }
</style>
<nav id='menu-ui' class='menu-ui'></nav>
<div id='map'></div>
<div id='loader'><span class='message'>loading</span></div>
<button onclick="window.location='http://athletedataviz.com/products';" method='GET' id='render_map'>Order Viz!</button>

</div>

<!-- Create the map -->
<script>
// API tokens 
L.mapbox.accessToken = '{{ mapbox_accessToken|safe }}';
mapboxgl.accessToken = '{{ mapbox_gl_accessToken|safe }}';

// user-selected variables 
var loader = document.getElementById('loader');
startLoading();

// data passed from flask back-end 
var center_point = [{{ avg_lat|safe }}, {{ avg_long|safe }}]
var stravaLineGeoJson = {{ geojson_data|safe }} ;
var heatPointsRaw =  {{ heatpoints|safe }} ; 

// Mapbox JS Api - import heatmap layer 
var map = L.map('map').setView(center_point, 10);
heatPoints = heatPointsRaw.map(function (p) { return [p['lt'], p['lg'], p[heattype]]; });
var heatColors = {
                  0.4: 'blue',
                  0.6: 'cyan',
                  0.7: 'lime',
                  0.8: 'yellow',
                  1.0: 'red'
                 };
var heatConfig = {minOpacity: parseFloat(document.getElementById('minOpacity').value),
                  radius: parseFloat(document.getElementById('radius').value),
                  blur: parseFloat(document.getElementById('blur').value),
                  max: 1,
                  gradient: heatColors};
var heat = L.heatLayer(heatPoints, heatConfig).addTo(map);

var gl = L.mapboxGL({
    accessToken: mapboxgl.accessToken,
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v8',
    center : center_point,
    zoom: 10,
    minZoom: 4,
    maxZoom: 16
}).addTo(map);
/*
var linestring_src = new mapboxgl.GeoJSONSource({
    data: stravaLineGeoJson,
    maxzoom : 14,
    buffer : 5,
    tolerance : 100
});

var linestring = L.mapboxGL({
    accessToken: mapboxgl.accessToken,
    container: 'map',
    data: linestring_src,
    style: {
        "id": "linestring",
        "type": "line",
        "source": "linestring",
        "layout": {
            "line-cap" : "round",
            "line-join": "round"
        },
        "paint": {
            "line-opacity": document.getElementById("line_opacity").value,
            "line-width": document.getElementById("line_width").value,
            "line-color": document.getElementById("line_color").value
        },
    center : center_point,
    zoom: 10,
    minZoom: 4,
    maxZoom: 16
  }
}).addTo(map);
*/
/*
gl.addSource('linestring', linestring_src);
gl.addLayer({
        "id": "linestring",
        "type": "line",
        "source": "linestring",
        "layout": {
            "line-cap" : "round",
            "line-join": "round"
        },
        "paint": {
            "line-opacity": document.getElementById("line_opacity").value,
            "line-width": document.getElementById("line_width").value,
            "line-color": document.getElementById("line_color").value
        }
    });
*/
finishedLoading();

function startLoading() {
    loader.className = '';
}

function finishedLoading() {
    // first, toggle the class 'done', which makes the loading screen
    // fade out
    loader.className = 'done';
    setTimeout(function() {
        // then, after a half-second, add the class 'hide', which hides
        // it completely and ensures that the user can interact with the
        // map again.
        loader.className = 'hide';
    }, 500);
}

function render() {

    heatConfig = {minOpacity: parseFloat(document.getElementById('minOpacity').value),
                  radius: parseFloat(document.getElementById('radius').value),
                  blur: parseFloat(document.getElementById('blur').value),
                  max: 1,
                  gradient: heatColors};

    heatPoints = heatPointsRaw.map(function (p) { return [p['lt'], p['lg'], 
                         p[document.getElementById('heattype').value]]; });

    heat.setLatLngs(heatPoints);
    heat.setOptions(heatConfig);

}

function log(msg) {
    setTimeout(function() {
        throw new Error(msg);
    }, 0);
}

</script>

</body>
</html>

