{% extends "base.html" %} {% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            {% for message in get_flashed_messages() %}
            <div class="alert alert-success" ng-show="get_flashed_messages() != null">
                <a class="close" data-dismiss="alert" aria-label="close"></a>
                <p style="color: red;">{{ message }}</p>
            </div>
            {% endfor %}
            <div id="greeting" class="text-center">
            {% if session.access_token %}
                <h1>Welcome {{ athlete.firstname }}! </h1>
            {% endif %}
            </div>
            <div class="col-sm-6 text-center">
                 <h3> 1) Get you Activities </h3>
                <form class="form-horizontal" id="dl_form" action="#">
                    <br>
                    <button id= 'dl_data_btn' type="submit" class="btn btn-primary" id="getData">Get Data</button>
                <!--<span class="help-block">Enter a Date Range.  Then click "Get Data"</span>-->
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" class="form-control" min="2012-00-01" max="2017-00-01" value="2015-01-01" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" class="form-control" min="2005-00-00" max="2025-00-30" value="2016-01-01" id="endDate">
                    </div>
                    <div class="form-group">
                        <!--<label for="act_limit">Activity Limit</label>-->
                        <!--<input type="input" class="form-control" value="50" id="act_limit">-->
                    </div>
                </form>
                <div id="progress">&nbsp; </div>
            </div>
            <div class="col-sm-6 text-center">
                <h3> 2) Design your Viz! </h3>
                {% if session.access_token %}
                <div id="view_map">
                    <form action="strava_mapbox" method="GET">
                        <input type="submit" class="btn btn-success" value="Viz Designer">
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-sm-6 text-center">
            <h3> View your available Activities </h3>
            <div class="table" id="act_table">
                Loading...
            </div>
        </div>
        <div class="col-sm-6 text-center">
            <h3> Delete your Data on AthleteDataViz </h3>
            <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#myModal"> Delete my Data </button>
            <br>
        </div>
    </div>
</div>



<!-- Modals -->
<div class="modal fade bs-example-modal-sm text-center" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Delete My Data - Confirmation</h4>
            </div>
            <div class="modal-body">
                <p> Are you sure you want to delete all data? </p>
                This will not effect your Strava account.
            </div>
            <div class="modal-footer text-center">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <form class="form-horizontal" action="delete_acts" method="POST">
                    <button  type="submit" class="btn btn-danger">Confirm Deletion</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade text-center" id="loginModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Login to AthleteDataViz</h4>
      </div>
      <div class="modal-body">
        <h4> Connect to Strava </h4>
        <a href="{{auth_url | safe}}">
        <img class="img-responsive center-block" src="/static/img/ConnectWithStrava.png" alt="Connect with Strava" title="Connect with Strava"></a>
        <br>
        <h4> Don't have a Strava Account? </h4>
        <p> Demo coming soon </p>
        </a>
        <br>
        
      </div>
      <div class="modal-footer text-center">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
function start_long_task() {
    // add task status elements
    document.getElementById('dl_data_btn').classList.add('disabled');
    div = $('<div class="progress"><div></div><div>0%</div></div>');
    div2 = $('<div id="status" class="text-center"></div>')
    $('#progress').append(div).append(div2);

    // create a progress bar
    var nanobar = new Nanobar({
        bg: '#44f',
        target: div[0].childNodes[0]
    });
    var params = {
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        act_limit: 500
    };
    // send ajax POST request to start background job
    $.ajax({
        type: 'POST',
        url: '/longtask',
        data: JSON.stringify(params),
        contentType: 'application/json;charset=UTF-8',
        success: function(data, status, request) {
            status_url = request.getResponseHeader('Location');
            update_progress(status_url, nanobar, div[0]);
        },
        error: function() {
            alert('Unexpected error');
        }
    });
}

function update_progress(status_url, nanobar, status_div) {
    // send GET request to status URL

    $.getJSON(status_url, function(data) {
        // update UI
        percent = parseInt(data['current'] * 100 / data['total']);
        nanobar.go(percent);
        $(status_div.childNodes[1]).text(percent + '%');
        $(status_div.childNodes[2]).text(data['status']);
        if (data['state'] != 'PENDING' && data['state'] != 'PROGRESS') {
            if ('result' in data) {
                // show result
                $(status_div.childNodes[3]).text('Result: ' + data['result']);
                $('#status').html("<strong> Result: "+data['result']+"</strong>");
                document.getElementById("dl_data_btn").classList.remove("disabled")
            } else {
                // something unexpected happened
                $(status_div.childNodes[3]).text('Result: ' + data['state']);
                $('#status').html("<strong> Result: "+data['state']+"</strong>");
            }
        } else {
            // rerun in 1 seconds
            setTimeout(function() {
                update_progress(status_url, nanobar, status_div);
                $('#status').html("<strong>"+data['status']+"</strong>");
                get_acts();
            }, 2500);
        }
    });
}

$('#dl_form').submit(function() {
    start_long_task();
    return false;
});

//Stop the loading bar when ajax requests complete
$(document).one("ajaxStop", function() {
    $("#loading").hide();
});

function get_acts() {
    {% if session.access_token %}
    $.get("{{ current_act_url|safe }}", function(data, status) {
        $('#act_table').html(data);
    });
    {% endif %}
}



$( document ).ready(function() {
    {% if session.access_token %}
    $('#act_table').on('load', get_acts());
    var today = moment().format('YYYY-MM-DD');
    var threeMonthsAgo = moment().subtract(90, 'days').format('YYYY-MM-DD');
    $('#startDate').val(threeMonthsAgo);
    $('#endDate').val(today);
    {% else %}
    $("#loginModal").modal("show");
    {% endif %}
});

</script>
{% endblock %}
