{% extends "base.html" %} {% block import_script %}
<!-- Mapbox GL -->
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.12.2/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.12.2/mapbox-gl.css' rel='stylesheet'>
<!-- Mapbox JS -->
<script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
<!-- Leaflet Heat !-->
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script>
<!-- Mapbox JS extended to Mapbox GL JS !-->
<script src="/static/js/leaflet-mapbox-gl.js"></script>
<!-- Bootstrap Slider -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/5.2.5/css/bootstrap-slider.min.css">
<script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/5.2.5/bootstrap-slider.min.js'></script>
<!-- Leaflet Image -->
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-image/v0.0.4/leaflet-image.js'></script>
<!-- Twitter -->
<script>
! function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
        p = /^http:/.test(d.location) ? 'http' : 'https';
    if (!d.getElementById(id)) {
        js = d.createElement(s);
        js.id = id;
        js.src = p + '://platform.twitter.com/widgets.js';
        fjs.parentNode.insertBefore(js, fjs);
    }
}(document, 'script', 'twitter-wjs');
</script>
{% endblock %} {% block content %}
<!-- Sidebar -->
<div id="container">
    <div id="sidebar">
        <div class="sidebar-wrapper">
            <div class="panel panel-default" id="features">
                <div class="panel-heading">
                    <h3 class="panel-title">Designer Toolbar</h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-8 col-md-8">
                            <button type="submit" id='snap' class="btn btn-primary" data-toggle="modal" data-target="#SaveDesign">Save Design</button>
                            <br>
                            <div id="spinner"></div>
                            <br>
                            <form class="Refresh" onclick="render();return false;" id="Refresh">
                                <button class="btn btn-primary">Refresh Map
                                </button>
                            </form>
                            <br>
                            <b>Viz Type</b>
                            <select id='VizType' name="VizType" style="font-size: 20px;">
                                <option value="heat-line">heat-line</option>
                                <!--<option value="heat-point">heat-point</option>-->
                            </select>
                            <br>
                            <br>
                            <b>Map Style</b>
                            <select id='mapStyle' name="mapStyle" value="dark" style="font-size: 20px;">
                                <option value="dark-nolabel">Dark: no Label</option>
                                <option value="dark">Dark: Label</option>
                                <option value="basic">Basic</option>
                                <option value="streets">Streets</option>
                                <option value="emerald">Emerald</option>
                                <option value="bright">Bright</option>
                                <option value="light">Light</option>
                                <option value="satellite">Satellite</option>
                            </select>
                            <br>
                            <br>
                            <div id="VizType_hide_heat-line" class="collapse in">
                                <b>Line Color</b>
                                <select id='line_color' name="line_color" style="font-size: 18px;">
                                    <option value="#FF0000">Dark Red</option>
                                    <option value="#00FFFF">Teal</option>
                                    <option value="#33FF00">Lime</option>
                                    <option value="#FFFF00">Dark Yellow</option>
                                    <option value="#0000FF">Dark Blue</option>
                                    <option value="#9900FF">Dark Purple</option>
                                    <option value="#FF0099">Light Pink</option>
                                    <option value="#00CCFF">Light Blue</option>
                                    <option value="#33FF00">Light Green</option>
                                    <option value="#FF9900">Light Orange</option>
                                </select>
                                <br>
                                <br>
                                <b> Line Width </b>
                                <input id="line_width" class="slider" data-slider-id='line_width_slider' type="text" data-slider-min="0.5" data-slider-value="1.5" data-slider-max="5" data-slider-step="0.5" onclick="render()">
                                <br>
                                <br>
                                <b>Line Opacity</b>
                                <input type="text" class="slider" id="line_opacity" data-slider-min="0.1" data-slider-value="0.5" data-slider-max="1" data-slider-step="0.1" onclick="render()">
                            </div>
                            <div id="VizType_hide_heat-point" class="collapse">
                                <b>Heat Type</b>
                                <select id='heattype' name="line_color" style="font-size: 18px;">
                                    <option value="d">Density</option>
                                    <option value="s">Speed</option>
                                    <option value="g">Grade</option>
                                </select>
                                <br>
                                <br>
                                <b>Heat Color</b>
                                <select id='heat_color' name="heat_color" style="font-size: 18px;">
                                    <option value="heatColors1">Green-Yel-Red</option>
                                    <option value="heatColors2">Intense</option>
                                    <option value="heatColors3">Xmas</option>
                                </select>
                                <br>
                                <br>
                                <b>Heat Blur</b>
                                <input type="text" id="blur" class="slider" data-slider-min="1" data-slider-value="5" data-slider-max="20" data-slider-step="1">
                                <br>
                                <br>
                                <b>Heat Radius</b>
                                <input type="text" id="radius" class="slider" data-slider-min="3" data-slider-value="5" data-slider-max="20" data-slider-step="0.5">
                                <br>
                                <br>
                                <b>Heat Opacity</b>
                                <input type="text" id="minOpacity" class="slider" data-slider-min="0.05" data-slider-value="0.5" data-slider-max="1" data-slider-step="0.05">
                                <br>
                                <br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id='map'></div>
    <div id="loading">
        <div class="loading-indicator">
            <div class="progress progress-striped active">
                <div class="progress-bar progress-bar-info progress-bar-full"></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="SaveDesign" role="dialog" tabindex="-1" aria-labelledby="SaveDesign">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h3 class="modal-title text-center">Your Athlete Data Viz creation</h3>
                </div>
                <div class="modal-body">
                    <div id='snapshot'></div>
                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="text-center">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Try a new Design</button>
                            <a type="button" id="download_viz" class="btn btn-default" href="#" download="ADV_viz.jpg">Download Viz</a>
                        </div>
                    </div>
                    <br>
                    <div class="row text-center">
                        <div class="text-center">
                            <!-- Shares -->
                            <a id="share_fb" class="btnz share facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://athletedataviz-pro.herokuapp.com"><i class="fa fa-facebook text-center"></i> Share</a>
                            <a id="share_gplus" class="btnz share gplus" href="https://plus.google.com/share?url=https://athletedataviz-pro.herokuapp.com"><i class="fa fa-google-plus text-center"></i> Share</a>
                            <a id="share_twit" class="btnz share twitter" href="https://twitter.com/home?status=Check%20out%20custom%20designs%20at%20www.athletedataviz.com"<i class="fa fa-twitter text-center"></i> Tweet</a>
                            <a id="share_pin" class="btnz share pinterest" href="https://pinterest.com/pin/create/button/?url=https://athletedataviz-pro.herokuapp.com&media=https%3A//athletedataviz-pro.herokuapp.com/static/img/title_gallery_3.jpg&description=Check%20out%20my%20custom%20design!"><i class="fa fa-pinterest text-center"></i> Pin it</a>
                            <a id="share_link" class="btnz share linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://athletedataviz-pro.herokuapp.com&title=Athlete%20Data%20Viz&summary=Check%20out%20my%20custom%20design!&source=https://athletedataviz-pro.herokuapp.com/static/img/title_gallery_3.jpg"><i class="fa fa-linkedin text-center"></i> LinkedIn</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Map Designer Time! -->
    <script>
    jQuery(document).ready(function($) {
        $('.share').click(function() {
            var NWin = window.open($(this).prop('href'), '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');
            if (window.focus) {
                NWin.focus();
            }
            return false;
        });
    });
    // API tokens 
    L.mapbox.accessToken = '{{ mapbox_accessToken|safe }}';
    mapboxgl.accessToken = '{{ mapbox_gl_accessToken|safe }}';
    //Global variables
    var heatColors1 = {
        0.1: 'blue',
        0.6: 'cyan',
        0.7: 'lime',
        0.8: 'yellow',
        1.0: 'red'
    };
    var heatColors2 = {
        0.1: 'purple',
        0.6: 'pink',
        0.7: 'blue',
        0.8: 'yellow',
        1.0: 'orange'
    };
    var heatColors3 = {
        0.1: 'green',
        0.6: 'aquamarine',
        0.7: 'blanchedalmond',
        0.8: 'coral',
        1.0: 'red'
    };

    var lineHeatStyle = {
        "id": "linestring",
        "type": "line",
        "source": "linestring",
        "layout": {
            "line-cap": "round",
            "line-join": "round"
        },
        "paint": {
            "line-opacity": parseFloat(document.getElementById("line_opacity").value),
            "line-width": parseFloat(document.getElementById("line_width").value),
            "line-color": document.getElementById("line_color").value
        },
        "transition": {
            "duration": 300,
            "delay": 0
        }

    };
    var center_point = [{{avg_lat | safe}}, {{avg_long | safe}}];
    var heatPoints;
    var stravaLineGeoJson;
    var linestring_src;
    var heat;
    var maxScale;
    var map = L.mapbox.map('map').setView(center_point, 10)
    var dark_style = 'mapbox://styles/mapbox/dark-v8'
    try {
        var gl = L.mapboxGL({
            accessToken: mapboxgl.accessToken,
            container: 'map',
            style: 'mapbox://styles/rsbaumann/ciiia74pe00298ulxsin2emmn',
            center: center_point,
            zoom: 9,
            minZoom: 1,
            maxZoom: 20,
        }).addTo(map);
    } catch (e) {
        var mapContainer = document.getElementById('map');
        mapContainer.parentNode.removeChild(mapContainer);
        document.getElementById('config-fields').setAttribute('disabled', 'yes');
        openErrorModal('This site requires WebGL, but your browser doesn\'t seem' +
            ' to support it. Sorry.');
    }

    gl._glMap.dragRotate.disable();

    function getDataHeat() {
        var r = $.Deferred();
        $.getJSON('{{ heatpoint_url|safe}}', function(data) {
            heatPointsRaw = JSON.parse(data);
            heatPoints = heatPointsRaw.map(function(p) {
                maxScale = Math.max(p[document.getElementById('heattype').value])
                return [p['lt'], p['lg'],
                    p[document.getElementById('heattype').value]
                ];
            });
            r.resolve();
        });
        return r;
    };

    function getDataLinestring() {
        var r = $.Deferred();
        $.getJSON('{{heatline_url|safe}}', function(data) {
            stravaLineGeoJson = JSON.parse(data);
            r.resolve();
        });
        return r;
    };

    function addLayerHeat() {
        // Mapbox JS Api - import heatmap layer
        var heatConfig = {
            minOpacity: parseFloat(0.5),
            radius: parseFloat(5),
            blur: parseFloat(5),
            max: parseFloat(maxScale),
            gradient: heatColors1
        };
        heat = L.heatLayer(heatPoints, heatConfig).addTo(map);
        map.removeLayer(heat);
    };

    function addLayerLinestring() {
        //Create source for linestrings
        linestring_src = new mapboxgl.GeoJSONSource({
            data: stravaLineGeoJson,
            maxzoom: 17,
            buffer: 10,
            tolerance: 0.5
        });
        //Add linestrings to map and set the visibility to "hidden"
        gl._glMap.addSource('linestring', linestring_src);
        gl._glMap.addLayer(lineHeatStyle);
        render();
    };

    //Load the data asrchnoutsly from api, then add layers to map
    //getDataHeat().done(addLayerHeat);
    getDataLinestring().done(addLayerLinestring);

    //Stop the loading bar when ajax requests complete
    $(document).one("ajaxStop", function() {
        $("#loading").hide();
    });

    //////////////// SLIDERS AND BUTTON ACTIONS ////////////

    //on change of VizType, show only menu options linked to selected viztype
    $('#VizType').change(function() {
        var selector = '#VizType_hide_' + $(this).val();
        //hide all elements
        $('#VizType_hide_heat-line').collapse('hide');
        $('#VizType_hide_heat-point').collapse('hide');
        //show only element connected to selected option
        $(selector).collapse('show');
    });

    $('#line_width').slider({
        formatter: function(value) {
            return 'Value: ' + value;
        }
    });
    $('#line_width').slider().on('slide', function(ev) {
        $('#line_width').slider('setValue', ev.value);
        render();
    });
    $('#line_opacity').slider({
        formatter: function(value) {
            return 'Value: ' + value;
        }
    });
    $('#line_opacity').slider().on('slide', function(ev) {
        $('#line_opacity').slider('setValue', ev.value);
        render();
    });
    $('#blur').slider({
        formatter: function(value) {
            return 'Value: ' + value;
        }
    });
    $('#blur').slider().on('slide', function(ev) {
        $('#blur').slider('setValue', ev.value);
        render();
    });
    $('#radius').slider({
        formatter: function(value) {
            return 'Value: ' + value;
        }
    });
    $('#radius').slider().on('slide', function(ev) {
        $('#radius').slider('setValue', ev.value);
        render();
    });
    $('#minOpacity').slider({
        formatter: function(value) {
            return 'Value: ' + value;
        }
    });
    $('#minOpacity').slider().on('slide', function(ev) {
        $('#minOpacity').slider('setValue', ev.value);
        render();
    });
    $('#heat_color').on(' touch tap', render);
    $('#Refresh').on('click touch tap', switchMapStyle);
    $('#Refresh').on('click touch tap', render);
    $('#VizType').on('click touch tap', render);
    $('#mapStyle').on('click touch tap', switchMapStyle);
    $('#heattype').on('click touch tap', render);
    $('#heat_color').on('click touch tap', render);
    $('#line_color').on('click touch tap', render);
    $('#snap').on('click touch tap', generateMap);

    var VizType = 'heat-line'
    var map_style = 'dark-nolabel'

    function switchLayer() {
        layer = document.getElementById("mapStyle").value
        if (layer != 'dark-nolabel') {
            gl._glMap.setStyle('mapbox://styles/mapbox/' + layer + '-v8');
        } else {
            gl._glMap.setStyle('mapbox://styles/rsbaumann/ciiia74pe00298ulxsin2emmn');
        }
        gl._glMap.on('style.load', function() {
            try {
                addLayerLinestring();
            } catch (err) {
                console.log(err);
            }
            try {
                if (document.getElementById("VizType").value == "heat-line") {
                    set_visibility(gl._glMap, 'linestring', 'on')
                }
            } catch (err) {
                console.log(err);
            }
            try {
                paintLayer(gl._glMap,
                    document.getElementById("line_color").value,
                    parseFloat($('#line_width').slider('getValue')),
                    parseFloat($('#line_opacity').slider('getValue')),
                    'linestring');
            } catch (err) {
                console.log(err);
            }
        });
    };

    function set_visibility(mapid, id, onoff) {
        var visibility = mapid.getLayoutProperty(id, 'visibility');
        if (onoff == 'off') {
            mapid.setLayoutProperty(id, 'visibility', 'none');
        } else if (onoff == 'on') {
            mapid.setLayoutProperty(id, 'visibility', 'visible');
        }
    };

    function paintLayer(mapid, color, width, opacity, layer) {
        mapid.setPaintProperty(layer, 'line-color', color);
        mapid.setPaintProperty(layer, 'line-width', width);
        mapid.setPaintProperty(layer, 'line-opacity', opacity);
    }

    function updateHeat() {
        if (document.getElementById("heat_color").value == "heatColors2") {
            heatColors = heatColors2
        } else if (document.getElementById("heat_color").value == "heatColors3") {
            heatColors = heatColors3
        } else {
            heatColors = heatColors1
        }

        heatPoints = heatPointsRaw.map(function(p) {
            maxScale = Math.max(p[document.getElementById('heattype').value])
            return [p['lt'], p['lg'],
                p[document.getElementById('heattype').value]
            ];
        });

        heatConfig = {
            minOpacity: parseFloat($('#minOpacity').slider('getValue')),
            radius: parseFloat($('#radius').slider('getValue')),
            blur: parseFloat($('#blur').slider('getValue')),
            max: parseFloat(maxScale),
            gradient: heatColors
        };
    }

    function switchMapStyle() {
        //Check if the mapStyle changed - if so, change it here
        if (document.getElementById("mapStyle").value != map_style) {
            switchLayer();
            map_style = document.getElementById("mapStyle").value;
        }
    }

    function render() {
        //Check if the viz type changed - if so, change it here  
        if (document.getElementById("VizType").value != VizType) {
            if (document.getElementById("VizType").value == "heat-point") {
                try {
                    set_visibility(gl._glMap, 'linestring', 'off')
                } catch (err) {
                    console.log(err);
                }
                try {
                    heat.addTo(map)
                } catch (err) {
                    console.log(err);
                }
                VizType = 'heat-point'
            } else if (document.getElementById("VizType").value == "heat-line") {
                try {
                    map.removeLayer(heat);
                } catch (err) {
                    console.log(err);
                }
                try {
                    set_visibility(gl._glMap, 'linestring', 'on');
                    paintLayer(gl._glMap,
                        document.getElementById("line_color").value,
                        parseFloat($('#line_width').slider('getValue')),
                        parseFloat($('#line_opacity').slider('getValue')),
                        'linestring');
                } catch (err) {
                    console.log(err);
                }
                VizType = 'heat-line'
            }
            //Check if the viz type did not change - if so, update values and render here
        } else if (document.getElementById("VizType").value == VizType) {
            if (VizType == 'heat-point') {
                //update the heatmap
                try {
                    updateHeat();
                    heat.setOptions(heatConfig);
                } catch (err) {
                    console.log(err);
                }
            } else if (VizType == 'heat-line') {
                //Update the linestring layer
                try {
                    paintLayer(gl._glMap,
                        document.getElementById("line_color").value,
                        parseFloat($('#line_width').slider('getValue')),
                        parseFloat($('#line_opacity').slider('getValue')),
                        'linestring');
                } catch (err) {
                    console.log(err);
                }
            }
        }
    }

    function log(msg) {
        setTimeout(function() {
            throw new Error(msg);
        }, 0);
    }

    /**
     * Conserve aspect ratio of the orignal region. Useful when shrinking/enlarging
     * images to fit into a certain area.
     */
    function calculateAspectRatioFit(srcWidth, srcHeight, maxWidth, maxHeight) {

        var ratio = Math.min(maxWidth / srcWidth, maxHeight / srcHeight);
        return {
            width: srcWidth * ratio,
            height: srcHeight * ratio
        };
    }

    // Helper functions
    function toPixels(length) {
        'use strict';
        var unit = 'in';
        var conversionFactor = 96;
        if (unit == 'mm') {
            conversionFactor /= 25.4;
        }
        return conversionFactor * length + 'px';
    }

    //Download link
    function download_img(link, img_src, filename) {
        link.href = img_src;
        link.download = filename;
    }

    // High-res map rendering
    function generateMap() {
        'use strict';

        document.getElementById('spinner').style.display = 'inline-block';
        document.getElementById('snap').classList.add('disabled');
        //Get the current map style
        var style;
        var layer = document.getElementById("mapStyle").value
        if (layer != 'dark-nolabel') {
            style = 'mapbox://styles/mapbox/' + layer + '-v8';
        } else {
            style = 'mapbox://styles/rsbaumann/ciiia74pe00298ulxsin2emmn';
        }
        var width = 8;
        var height = 6;
        var dpi = 300;
        var format = 'jpg';
        var unit = 'in';
        var zoom = gl._glMap.getZoom();
        var center = gl._glMap.getCenter();
        var bearing = gl._glMap.getBearing();

        createPrintMap(width, height, dpi, format, unit, zoom, center,
            bearing, style);
    }

    function createPrintMap(width, height, dpi, format, unit, zoom, center,
        bearing, style, source) {
        'use strict';

        // Calculate pixel ratio
        var actualPixelRatio = window.devicePixelRatio;
        Object.defineProperty(window, 'devicePixelRatio', {
            get: function() {
                return dpi / 96
            }
        });

        // Create map container
        var hidden = document.createElement('div');
        hidden.className = 'hidden-map';
        document.body.appendChild(hidden);
        var container = document.createElement('div');
        container.style.width = toPixels(width);
        container.style.height = toPixels(height);
        hidden.appendChild(container);
        //remove any existing image elements
        snapshot.innerHTML = '';
        var img = document.createElement('img');
        //Show loading image
        var w = window.innerWidth;
        var h = window.innerHeight;
        if (w > 640) {
            w = 640;
            h = 480;
        } else {
            w = w * 0.8;
            h = h * 0.8;
        }
        img.width = w;
        img.height = h;
        img.src = "{{ url_for('static', filename='img/loading.gif') }}";
        snapshot.appendChild(img);
        $("#snapshot_img").addClass("img-responsive center-block");


        // Render map
        var renderMap = new mapboxgl.Map({
            container: container,
            center: center,
            zoom: zoom,
            style: style,
            bearing: bearing,
            interactive: false,
            attributionControl: false
        });

        renderMap.on('style.load', function() {
            console.log('adding source linestring layer!');
            linestring_src = new mapboxgl.GeoJSONSource({
                data: stravaLineGeoJson,
                maxzoom: 17
            });
            renderMap.addSource('linestring', linestring_src);
            renderMap.addLayer(lineHeatStyle);
            try {
                if (document.getElementById("VizType").value == "heat-line") {
                    set_visibility(renderMap, 'linestring', 'on')
                }
            } catch (err) {
                console.log(err);
            }
            paintLayer(renderMap,
                document.getElementById("line_color").value,
                parseFloat($('#line_width').slider('getValue')),
                parseFloat($('#line_opacity').slider('getValue')),
                'linestring');
        });

        renderMap.once('load', function() {
            if (format == 'jpg') {
                try {
                    var canvas = renderMap.getCanvas();
                    var targetDims = calculateAspectRatioFit(canvas.width, canvas.height, w, h);
                    img.width = targetDims['width'];
                    img.height = targetDims['height'];
                    img.href = img.src;
                    img.id = 'snapshot_img';
                    img.src = canvas.toDataURL("image/jpeg", 1);
                    img.class = "img-responsive center-block";
                    //put the new image in the div
                    snapshot.innerHTML = '';
                    snapshot.appendChild(img);
                    $("#snapshot_img").addClass("img-responsive center-block");
                    $('#download_viz').attr('href', img.src).
                    attr('download', "ADV_{{ath_name}}.jpg");
                    $('#facebook_share').attr('data-href', img.src)
                } catch (err) {
                    console.log(err);
                }

            } else {
                var pdf = new jsPDF({
                    orientation: width > height ? 'l' : 'p',
                    unit: unit,
                    format: [width, height],
                    compress: true
                });

                pdf.addImage(renderMap.canvas.canvas.toDataURL('image/jpeg', 1),
                    'jpeg', 0, 0, width, height);
                pdf.save('map.pdf');
            }
            renderMap.remove();
            hidden.parentNode.removeChild(hidden);
            Object.defineProperty(window, 'devicePixelRatio', {
                get: function() {
                    return actualPixelRatio
                }
            });
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('snap').classList.remove('disabled');
        });
    }

    ///////////////////  Error Modal  //////////
    var origBodyPaddingRight;

    function openErrorModal(msg) {
        'use strict';
        var modal = document.getElementById('errorModal');
        document.getElementById('modal-error-text').innerHTML = msg;
        modal.style.display = 'block';
        document.body.classList.add('modal-open');
        document.getElementById('modal-backdrop').style.height =
            modal.scrollHeight + 'px';

        if (document.body.scrollHeight > document.documentElement.clientHeight) {
            origBodyPaddingRight = document.body.style.paddingRight;
            var padding = parseInt((document.body.style.paddingRight || 0), 10);
            document.body.style.paddingRight = padding + measureScrollbar() + 'px';
        }
    }

    function closeErrorModal() {
        'use strict';
        document.getElementById('errorModal').style.display = 'none';
        document.body.classList.remove('modal-open');
        document.body.style.paddingRight = origBodyPaddingRight;
    }

    function measureScrollbar() {
        'use strict';
        var scrollDiv = document.createElement('div');
        scrollDiv.className = 'modal-scrollbar-measure';
        document.body.appendChild(scrollDiv);
        var scrollbarWidth = scrollDiv.offsetWidth - scrollDiv.clientWidth;
        document.body.removeChild(scrollDiv);
        return scrollbarWidth;
    }
    </script>
    {% endblock %}
